# 本地测试操作手册（边牧级）

本手册提供在本地环境（Windows/Linux）执行数据集测试的完整流程。
请注意每条命令的执行环境（PowerShell/CMD 或 bash）

## 目录

1. [环境准备](#1-环境准备)
2. [环境检查](#2-环境检查)
3. [准备项目代码](#3-准备项目代码)
4. [安装依赖](#4-安装依赖)
5. [准备模型和数据](#5-准备模型和数据)
6. [执行测试](#6-执行测试)
7. [查看结果](#7-查看结果)
8. [常见问题](#8-常见问题)

---

## 1. 环境准备

### 1.1 系统要求

- **操作系统**: Windows 10/11 或 Linux (Ubuntu 20.04+)
- **Python**: 3.10 或 3.11
- **GPU**: NVIDIA GPU（推荐 8GB+ 显存，支持 CUDA 12.4）
- **内存**: 16GB+ RAM
- **磁盘空间**: 至少 50GB 可用空间（用于模型和数据集）

### 1.2 安装 Python

**Windows**:
```powershell
# 下载并安装 Python 3.11
# 从 https://www.python.org/downloads/ 下载安装包
# 安装时勾选 "Add Python to PATH"

# 验证安装
python --version
pip --version
```

**Linux**:
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.11 python3.11-venv python3-pip

# 验证安装
python3.11 --version
pip3 --version
```

---

## 2. 环境检查

### 2.1 检查 GPU 和 CUDA（如果有 NVIDIA GPU）

**Windows**:
```powershell
# 检查 GPU
nvidia-smi

# 检查 CUDA 版本（如果已安装）
nvcc --version
```

**Linux**:
```bash
# 检查 GPU
nvidia-smi

# 检查 CUDA 版本（如果已安装）
nvcc --version
```

### 2.2 检查 Python 环境

```bash
# Windows (PowerShell/CMD)
python --version

# Linux
python3 --version
```

### 2.3 检查 Git（可选）

```bash
# Windows/Linux
git --version

# 如果未安装，Windows 从 https://git-scm.com/download/win 下载
# Linux: sudo apt install git
```

---

## 3. 准备项目代码

### 3.1 方式一：Git 克隆（推荐）

**Windows (PowerShell)**:
```powershell
# 进入工作目录
cd D:\Projects  # 或其他目录

# 克隆项目
git clone https://github.com/YANHAN-BLCU/NeuroLens.git

cd NeuroLens
```

**Linux**:
```bash
# 进入工作目录
cd ~/Projects  # 或其他目录

# 克隆项目
git clone https://github.com/YANHAN-BLCU/NeuroLens.git

cd NeuroLens
```

### 3.2 方式二：直接下载 ZIP

1. 访问 https://github.com/YANHAN-BLCU/NeuroLens
2. 点击 "Code" -> "Download ZIP"
3. 解压到本地目录

### 3.3 验证代码

**Windows (PowerShell)**:
```powershell
cd D:\Projects\NeuroLens
dir
# 应看到: docker/, scripts/, engine/, requirements.txt 等
```

**Linux**:
```bash
cd ~/Projects/NeuroLens
ls -la
# 应看到: docker/, scripts/, engine/, requirements.txt 等
```

---

## 4. 安装依赖

### 4.1 创建虚拟环境（推荐）

**Windows (PowerShell)**:
```powershell
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\Activate.ps1
# 如果遇到执行策略错误，运行: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**Linux**:
```bash
# 创建虚拟环境
python3.11 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

### 4.2 安装 Python 依赖

```bash
# 升级 pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

**注意**: 如果使用 GPU，确保安装的 PyTorch 支持 CUDA：
```bash
# 检查 PyTorch CUDA 支持
python -c "import torch; print('CUDA available:', torch.cuda.is_available()); print('CUDA version:', torch.version.cuda if torch.cuda.is_available() else 'N/A')"
```

### 4.3 验证安装

```bash
# 检查关键依赖
python -c "import torch; import transformers; import modelscope; print('All dependencies installed successfully')"
```

---

## 5. 准备模型和数据

### 5.1 设置 ModelScope Token

**Windows (PowerShell)**:
```powershell
# 设置环境变量（当前会话）
$env:MODELSCOPE_TOKEN="ms-d9625645-acb2-444f-b0df-6685dfc743b5"

# 或创建 .env 文件
echo "MODELSCOPE_TOKEN=ms-d9625645-acb2-444f-b0df-6685dfc743b5" > .env
```

**Linux**:
```bash
# 设置环境变量（当前会话）
export MODELSCOPE_TOKEN=ms-d9625645-acb2-444f-b0df-6685dfc743b5

# 或创建 .env 文件
echo "MODELSCOPE_TOKEN=ms-d9625645-acb2-444f-b0df-6685dfc743b5" > .env
```

### 5.2 下载模型

```bash
# 下载所有 8B 模型
python scripts/download_models.py --all-8b --output ./ms_models
```

**注意**: 
- 模型较大（约 16GB），下载需要时间
- 确保有足够的磁盘空间
- 如果下载中断，可以重新运行命令继续下载

### 5.3 验证模型

```bash
# 检查模型是否存在
python scripts/check_models.py

# 或手动检查
# Windows
dir ms_models\LLM-Research\

# Linux
ls -la ms_models/LLM-Research/

# 应看到:
# - Meta-Llama-3-8B-Instruct/
# - Llama-Guard-3-8B/
```

### 5.4 准备 SALAD 数据集

```bash
# 下载数据集
python scripts/download_salad.py

# 验证数据集
# Windows
dir data\salad\raw\

# Linux
ls -la data/salad/raw/

# 应看到: base_set_train.jsonl, attack_enhanced_set_train.jsonl 等
```

---

## 6. 执行测试

### 6.1 快速测试（10 个样本）

只测试一个也行，能跑出来就行

**Windows (PowerShell)**:
```powershell
# 确保在项目根目录
cd D:\Projects\NeuroLens

# 确保虚拟环境已激活
.\venv\Scripts\Activate.ps1

# 运行快速测试
python scripts/evaluate_salad_pipeline.py `
  --data_dir ./data/salad/raw `
  --output ./logs/test_10.jsonl `
  --config base_set `
  --max_samples 10
```

**Linux**:
```bash
# 确保在项目根目录
cd ~/Projects/NeuroLens

# 确保虚拟环境已激活
source venv/bin/activate

# 运行快速测试
python scripts/evaluate_salad_pipeline.py \
  --data_dir ./data/salad/raw \
  --output ./logs/test_10.jsonl \
  --config base_set \
  --max_samples 10
```

### 6.2 完整测试（base_set，21,318 个样本）

**Windows (PowerShell)**:
```powershell
# 创建输出目录
New-Item -ItemType Directory -Force -Path ./logs

# 运行评估（后台运行）
Start-Process python -ArgumentList "scripts/evaluate_salad_pipeline.py", `
  "--data_dir", "./data/salad/raw", `
  "--output", "./logs/base_set.jsonl", `
  "--config", "base_set" `
  -RedirectStandardOutput "./logs/base_set.log" `
  -RedirectStandardError "./logs/base_set.log" `
  -NoNewWindow

# 查看进度
Get-Content ./logs/base_set.log -Wait -Tail 50
```

**Linux**:
```bash
# 创建输出目录
mkdir -p ./logs

# 运行评估（后台运行）
nohup python scripts/evaluate_salad_pipeline.py \
  --data_dir ./data/salad/raw \
  --output ./logs/base_set.jsonl \
  --config base_set \
  > ./logs/base_set.log 2>&1 &

# 查看进度
tail -f ./logs/base_set.log
```

### 6.3 其他配置测试

**Windows (PowerShell)**:
```powershell
# attack_enhanced_set (5,000 样本)
python scripts/evaluate_salad_pipeline.py `
  --data_dir ./data/salad/raw `
  --output ./logs/attack_enhanced_set.jsonl `
  --config attack_enhanced_set

# defense_enhanced_set (200 样本)
python scripts/evaluate_salad_pipeline.py `
  --data_dir ./data/salad/raw `
  --output ./logs/defense_enhanced_set.jsonl `
  --config defense_enhanced_set

# mcq_set (3,840 样本)
python scripts/evaluate_salad_pipeline.py `
  --data_dir ./data/salad/raw `
  --output ./logs/mcq_set.jsonl `
  --config mcq_set
```

**Linux**:
```bash
# attack_enhanced_set (5,000 样本)
python scripts/evaluate_salad_pipeline.py \
  --data_dir ./data/salad/raw \
  --output ./logs/attack_enhanced_set.jsonl \
  --config attack_enhanced_set

# defense_enhanced_set (200 样本)
python scripts/evaluate_salad_pipeline.py \
  --data_dir ./data/salad/raw \
  --output ./logs/defense_enhanced_set.jsonl \
  --config defense_enhanced_set

# mcq_set (3,840 样本)
python scripts/evaluate_salad_pipeline.py \
  --data_dir ./data/salad/raw \
  --output ./logs/mcq_set.jsonl \
  --config mcq_set
```

### 6.4 断点续传

```bash
# 从第 1000 个样本开始继续
python scripts/evaluate_salad_pipeline.py \
  --data_dir ./data/salad/raw \
  --output ./logs/base_set.jsonl \
  --config base_set \
  --start_from 1000
```

---

## 7. 查看结果

### 7.1 查看日志

**Windows (PowerShell)**:
```powershell
# 查看日志（实时）
Get-Content ./logs/base_set.log -Wait -Tail 50

# 查看最后 100 行
Get-Content ./logs/base_set.log -Tail 100
```

**Linux**:
```bash
# 查看日志（实时）
tail -f ./logs/base_set.log

# 查看最后 100 行
tail -n 100 ./logs/base_set.log
```

### 7.2 查看结果文件

**Windows (PowerShell)**:
```powershell
# 查看结果行数
(Get-Content ./logs/base_set.jsonl | Measure-Object -Line).Lines

# 查看最后几条结果
Get-Content ./logs/base_set.jsonl -Tail 5 | python -m json.tool
```

**Linux**:
```bash
# 查看结果行数
wc -l ./logs/base_set.jsonl

# 查看最后几条结果
tail -n 5 ./logs/base_set.jsonl | python -m json.tool
```

### 7.3 分析结果（可选）（没必要）

```bash
python scripts/analyze_salad_results.py \
  --input ./logs/base_set.jsonl
```

---

## 8. 常见问题（非常不常见，但是总会发生）

### 8.1 CUDA 不可用

**症状**: `torch.cuda.is_available()` 返回 `False`

**解决方案**:

1. **检查 GPU 驱动**:
   ```bash
   nvidia-smi
   # 如果命令不存在，需要安装 NVIDIA 驱动
   ```

2. **检查 PyTorch CUDA 版本**:
   ```bash
   python -c "import torch; print(torch.version.cuda)"
   # 确保 CUDA 版本与驱动兼容
   ```

3. **重新安装 PyTorch（如果需要）**:
   ```bash
   # 访问 https://pytorch.org/get-started/locally/
   # 根据系统选择正确的安装命令
   pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
   ```

4. **如果没有 GPU**:
   - 代码会自动回退到 CPU 模式
   - 但运行速度会很慢

### 8.2 显存不足（应该不用考虑）

**症状**: `CUDA out of memory`

**解决方案**:
- 模型已启用 4-bit 量化，如果仍不足，考虑：
  - 使用更小的 `max_tokens` 参数
  - 关闭其他占用 GPU 的程序（游戏、浏览器等）
  - 使用 CPU 模式（会很慢）
  - 升级 GPU（推荐至少 8GB 显存）

### 8.3 模型路径找不到

**症状**: `FileNotFoundError: Model not found`

**解决方案**:
```bash
# 检查模型路径
python scripts/check_models.py

# 如果模型不存在，重新下载
python scripts/download_models.py --all-8b --output ./ms_models
```

### 8.4 数据集路径错误

**症状**: `Data directory not found`

**解决方案**:
```bash
# 检查数据集是否存在
# Windows
dir data\salad\raw\

# Linux
ls -la data/salad/raw/

# 如果不存在，下载数据集
python scripts/download_salad.py
```

### 8.5 依赖安装失败

**症状**: `pip install` 失败

**解决方案**:
```bash
# 升级 pip
pip install --upgrade pip

# 使用国内镜像源（如果网络较慢）
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或逐个安装依赖，查看具体错误
pip install torch transformers modelscope
```

### 8.6 虚拟环境问题

**症状**: 找不到已安装的包

**解决方案**:
```bash
# 确保虚拟环境已激活
# Windows
.\venv\Scripts\Activate.ps1

# Linux
source venv/bin/activate

# 验证 Python 路径
which python  # Linux
where python  # Windows
# 应该指向 venv 目录
```

### 8.7 权限问题（Linux）

**症状**: `Permission denied`

**解决方案**:
```bash
# 不要使用 sudo 安装 Python 包到虚拟环境
# 确保虚拟环境目录有写权限
chmod -R u+w venv/

# 如果使用系统 Python，可能需要 sudo（不推荐）
```

---

## 快速参考

### 常用命令

**Windows (PowerShell)**:
```powershell
# 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 查看 GPU 使用情况
nvidia-smi

# 运行快速测试
python scripts/evaluate_salad_pipeline.py --data_dir ./data/salad/raw --output ./logs/test.jsonl --config base_set --max_samples 10

# 查看日志
Get-Content ./logs/test.log -Wait
```

**Linux**:
```bash
# 激活虚拟环境
source venv/bin/activate

# 查看 GPU 使用情况
nvidia-smi

# 运行快速测试
python scripts/evaluate_salad_pipeline.py --data_dir ./data/salad/raw --output ./logs/test.jsonl --config base_set --max_samples 10

# 查看日志
tail -f ./logs/test.log
```

### 文件路径

- **项目代码**: `./` (当前目录)
- **模型路径**: `./ms_models/LLM-Research/`
- **数据集路径**: `./data/salad/raw/`
- **输出结果**: `./logs/`
- **虚拟环境**: `./venv/`

### 环境变量

```bash
# Windows (PowerShell)
$env:MODELSCOPE_TOKEN="ms-d9625645-acb2-444f-b0df-6685dfc743b5"

# Linux
export MODELSCOPE_TOKEN=ms-d9625645-acb2-444f-b0df-6685dfc743b5
```

---

## 使用 Docker（可选）

如果你更喜欢使用 Docker，可以参考 [服务器测试操作手册](./服务器测试操作手册.md) 中的 Docker 部分。

**Windows**:
```powershell
# 构建镜像
docker build -t neurolens:v1.0 -f docker/Dockerfile .

# 启动容器
docker run --gpus all -it `
  --name neurolens `
  -v ${PWD}:/workspace `
  -e MODELSCOPE_TOKEN=ms-d9625645-acb2-444f-b0df-6685dfc743b5 `
  neurolens:v1.0 `
  /bin/bash
```

**Linux**:
```bash
# 构建镜像
docker build -t neurolens:v1.0 -f docker/Dockerfile .

# 启动容器
docker run --gpus all -it \
  --name neurolens \
  -v $(pwd):/workspace \
  -e MODELSCOPE_TOKEN=ms-d9625645-acb2-444f-b0df-6685dfc743b5 \
  neurolens:v1.0 \
  /bin/bash
```

---

**完成以上步骤后，即可在本地环境执行数据集测试。如有问题，请参考常见问题部分或查看项目文档。**

